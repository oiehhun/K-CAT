"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Migrations = void 0;
class Migrations {
    constructor(storage) {
        this.storage = storage;
    }
    async upgrade() {
        let version = await this.readVersion();
        const targetVersion = this.getVersion();
        console.log(`Current database version (${version}). Target version (${targetVersion})`);
        while (version < targetVersion) {
            console.log(`Upgrading from ${version} to ${version + 1}`);
            version++;
            const label = `Successfully upgraded to ${version}`;
            console.time(label);
            await this.onUpgrade(version);
            await this.writeVersion(version);
            console.timeEnd(label);
        }
    }
    async readVersion() {
        const data = await this.getDocumentReference().get();
        return data.data()?.version || 0;
    }
    async writeVersion(version) {
        await this.getDocumentReference().set({
            version: version,
        }, { merge: true });
    }
    // noinspection JSMethodCanBeStatic
    getVersionDocumentPath() {
        return 'version/current';
    }
    getDocumentReference() {
        return this.storage.doc(this.getVersionDocumentPath());
    }
}
exports.Migrations = Migrations;
//# sourceMappingURL=migrations.js.map